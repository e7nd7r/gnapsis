services:
  gnapsis:
    build: .
    ports:
      - "3000:3000"
    environment:
      # Neo4j connection (double underscore = nesting separator)
      - GNAPSIS_NEO4J__URI=bolt://neo4j:7687
      - GNAPSIS_NEO4J__USER=neo4j
      - GNAPSIS_NEO4J__PASSWORD=${NEO4J_PASSWORD:-changeme}
      # Embedding configuration (model baked into image)
      - GNAPSIS_EMBEDDING__PROVIDER=fastembed
      - GNAPSIS_EMBEDDING__MODEL=BAAI/bge-small-en-v1.5
      - GNAPSIS_EMBEDDING__DIMENSIONS=384
      - FASTEMBED_CACHE_DIR=/home/gnapsis/.fastembed_cache
      # API authentication (simple Bearer token, optional if using OAuth)
      - GNAPSIS_SERVER__API_KEY=${GNAPSIS_API_KEY:-}
      # OAuth 2.0 configuration (for Claude connectors via WorkOS)
      - GNAPSIS_SERVER__OAUTH_AUTHORIZATION_SERVER=${OAUTH_AUTHORIZATION_SERVER:-}
      - GNAPSIS_SERVER__RESOURCE_URL=${RESOURCE_URL:-}
      # Project configuration
      - GNAPSIS_PROJECT__NAME=${PROJECT_NAME:-vault}
    volumes:
      # Mount project/vault directory (set PROJECT_PATH in .env)
      - ${PROJECT_PATH:-.}:/home/gnapsis/project:ro
    working_dir: /home/gnapsis/project
    depends_on:
      neo4j:
        condition: service_healthy
    restart: unless-stopped

  neo4j:
    image: neo4j:5
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-changeme}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD:-changeme}", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

volumes:
  neo4j_data:
  neo4j_logs:
